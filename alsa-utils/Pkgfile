# Description: Utilities for the ALSA
# URL:         https://www.alsa-project.org/
# Depends on:  alsa-lib dialog

name=alsa-utils
version=1.2.15.1
release=1
source="ftp://ftp.alsa-project.org/pub/utils/$name-$version.tar.bz2
	0001-simplify-nocolors-menu.patch
	f77a269370af917585df59d8c21c89bca07b5b73.patch
	rc.alsa"

build() {
	# Build in separate dir is broken
	cd $name-$version

	patch -Np1 -i $SRC/0001-simplify-nocolors-menu.patch
	patch -Np1 -i $SRC/f77a269370af917585df59d8c21c89bca07b5b73.patch

	# Fix error when compiling alsatplg
	CFLAGS="$CFLAGS -latopology"

	autoreconf -fiv
	./configure \
		--prefix=/usr \
		--disable-alsaconf \
		--disable-alsatest \
		--disable-bat \
		--disable-nls \
		--disable-rst2man \
		--disable-xmlto \
		--disable-static \

	# Ensure --as-needed is applied to shared linker invocations
	sed -i 's/ -shared / -Wl,-O1,--as-needed\0/g' libtool

	make V=1
	make DESTDIR=$PKG install

	install -m 0755 -D $SRC/rc.alsa $PKG/etc/rc.d/alsa

	# Remove junk
	rm $PKG/usr/sbin/alsa-info.sh
	rm $PKG/usr/lib/alsa-topology/libalsatplg_module_nhlt.la
	rmdir $PKG/usr/share/man/man7
}
