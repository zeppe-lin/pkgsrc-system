# Description: Common UNIX Printing System
# URL:         https://openprinting.github.io/cups/
# Depends on:  acl libusb zlib linux-pam

# Maintainer notes on dependencies:
#   libusb: for usb printer backend (enabled)
#   dbus gnutls openssl: (enabled if installed)

name=cups
version=2.4.16
release=2
source="https://github.com/OpenPrinting/cups/releases/download/v$version/cups-$version-source.tar.gz
	rc.cups
	pam.cups"

build() {
	if pkgman isinst gnutls >/dev/null 2>&1; then
		PKGMK_CUPS=" --with-tls=gnutls"
	else
		PKGMK_CUPS=" --with-tls=openssl"
	fi

	# Build in separate dir is broken
	cd cups-$version

	# Note: In some minimal or socket-activated environments, CUPS may exit
	# on idle and the web UI at http://localhost:631 becomes unavailable.
	# We comment out IdleExitTimeout to keep cupsd running reliably.
	# If you prefer socket activation, re-enable IdleExitTimeout and ensure
	# cups.socket/Listen directives are configured to provide the web UI.
	sed '/^IdleExitTimeout/s/^/#/' -i conf/cupsd.conf.in

	CC=cc CXX=c++ ./configure \
		--prefix=/usr \
		--sysconfdir=/etc \
		--libdir=/usr/lib \
		--localstatedir=/var \
		--enable-acl \
		--with-cups-group=lp \
		--with-cups-user=daemon \
		--with-docdir=/usr/share/cups/doc \
		--with-languages="" \
		--with-logdir=/var/log/cups \
		--with-optim="$CFLAGS" \
		--with-rundir=/run/cups \
		--without-rcdir \
		--without-systemd \
		$PKGMK_CUPS

	make
	make BUILDROOT=$PKG install

	# Conflict with cups-filter
	rm -r $PKG/usr/share/cups/banners $PKG/usr/share/cups/data

	# Cleanup
	rm -r $PKG/usr/share/applications $PKG/usr/share/icons $PKG/run \
		$PKG/usr/share/locale

	# Fix perms
	chmod 0755 $PKG/var/cache $PKG/var/spool
	chmod -R +w $PKG

	# Service script and PAM module
	install -m 0755 -D $SRC/rc.cups   $PKG/etc/rc.d/cups
	install -m 0644 -D $SRC/pam.cups  $PKG/etc/pam.d/cups

	# Blacklist usblp kernel module
	mkdir -p $PKG/lib/modprobe.d
	echo 'blacklist usblp' > $PKG/lib/modprobe.d/cups-blacklist-usblp.conf
}
