# Description: Linux kernel (+Wi-Fi pentest patches)
# URL:         https://www.kernel.org/

# 5.4 LTS (Dec, 2025)
# https://www.kernel.org/category/releases.html

# TODO: Add kernel_gcc_patch for cpu optimization support?
#       https://github.com/graysky2/kernel_compiler_support

name=linux
version=5.4.251
release=1
_lwppver=1ad040b # Wi-Fi pentest patches version
source="https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-$version.tar.xz
	https://github.com/sighook/lwpp/archive/$_lwppver/lwpp-$_lwppver.tar.gz
	x86_64-dotconfig"

build() {
	unset LDFLAGS HOSTCFLAGS HOSTCXXFLAGS HOSTLDFLAGS
	local _kver _karch _imageloc _patch

	case $version in
	*.*.*) _kver=$version   ;;
	*.*)   _kver=$version.0 ;;
	esac

	case "$(uname -m)" in
	x86_64)
		_karch=x86_64
		_imageloc=arch/x86/boot/bzImage
		;;
	i386)
		_karch=i386
		_imageloc=arch/x86/boot/bzImage
		;;
	arm64)
		_karch=arm64
		_imageloc=arch/arm64/boot/Image
		;;
	arm)
		_karch=arm
		_imageloc=arch/arm/boot/zImage
		;;
	*)
		echo "Unsupported architecture $(uname -m)"
		exit 1
		;;
	esac

	cd $name-$version

	# apply Wi-Fi pentest patches
	for _patch in $SRC/lwpp-${_lwppver}*/${version%.*}/*.patch; do
		patch -p1 -i $_patch
	done

	make mrproper V=1

	if [ -f $SRC/$_karch-dotconfig ]; then
		cp $SRC/$_karch-dotconfig .config
		make -j ${JOBS:-1} olddefconfig ARCH=$_karch
	else
		make -j ${JOBS:-1} ${_karch}_defconfig ARCH=$_karch
	fi

	# XXX HOTFIX
	# *** [kernel/Makefile:150: kernel/kheaders_data.tar.xz] Error 2
	./scripts/config --disable CONFIG_IKHEADERS

	make -j ${JOBS:-1} all V=1

	make -j 1 modules_install V=1 ARCH=$_karch \
		INSTALL_MOD_PATH=$PKG INSTALL_MOD_STRIP=1

	depmod -a -b $PKG $_kver

	case "$_karch" in
	arm64 | arm)
		make -j 1 dtbs_install \
			ARCH=$_karch INSTALL_DTBS_PATH=$PKG/boot/tdbs
		;;
	esac

	install -m 0644 -D $_imageloc  $PKG/boot/vmlinuz-$version
	install -m 0644 -D .config     $PKG/boot/config-$version

	unlink $PKG/lib/modules/$_kver/build
	unlink $PKG/lib/modules/$_kver/source
}
