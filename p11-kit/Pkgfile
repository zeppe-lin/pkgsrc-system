# Description: Load and enumerate PKCS#11 modules
# URL:         https://p11-glue.github.io/p11-glue/p11-kit.html
# Depends on:  libffi libtasn1 make-ca scdoc

name=p11-kit
version=0.26.0
release=1
source="https://github.com/p11-glue/$name/releases/download/$version/$name-$version.tar.xz
	update-ca-trust.8.scdoc
	update-ca-trust.sh"

build() {
	meson setup build $name-$version \
		--prefix=/usr \
		--libexecdir=/usr/lib \
		--buildtype=plain \
		--wrap-mode=nodownload \
		-D b_lto=true \
		-D b_pie=true \
		-D trust_paths=/etc/pki/anchors \
		-D module_path=/usr/lib/pkcs11 \
		-D nls=false \
		-D test=false \
		-D bash_completion=enabled \
		-D zsh_completion=disabled \

	ninja -C build -j ${JOBS:-1} -v
	DESTDIR=$PKG ninja -C build install

	# replace trust-extract-compat with update-ca-trust wrapper
	install -m 0755 -D $SRC/update-ca-trust.sh \
		$PKG/usr/lib/p11-kit/trust-extract-compat
	mkdir -p $PKG/usr/sbin
	ln -fs ../lib/p11-kit/trust-extract-compat \
		$PKG/usr/sbin/update-ca-trust
	mkdir -p $PKG/usr/share/man/man8
	scdoc < $SRC/update-ca-trust.8.scdoc \
		> $PKG/usr/share/man/man8/update-ca-trust.8
}
